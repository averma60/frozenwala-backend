{% load static %}
{% include 'backend/header.html' %}
{% include 'backend/sidebar.html' %}

<style>
.success-message {
    color: green;
    font-weight: bold;
    border: 1px solid green;
    padding: 10px;
    margin: 10px 0;
    background-color: #dff0d8;
}

.section-box {
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed #ddd;
}

.detail-label {
    font-weight: 600;
    color: #fff;
}

.detail-value {
    color: #fff;
}

.dataTables_wrapper .dataTables_paginate,
.dataTables_info {
    display: none;
}

.timeline {
  list-style: none;
  padding-left: 0;
}

.timeline li {
  padding: 10px 0;
  border-left: 3px solid #28a745;
  padding-left: 15px;
  margin-left: 5px;
}

.timeline li strong {
  color: #fff;
}

.timeline .text-muted {
  font-size: 13px;
}

.timeline::before {
  display: none;
}

</style>

<div class="content-wrapper">
<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>Order Details</h1>

        {% if messages %}
          {% for message in messages %}
            <p class="success-message">{{ message }}</p>
          {% endfor %}
        {% endif %}
      </div>

      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item active">Order Details</li>
        </ol>
      </div>
    </div>
  </div>
</section>

<section class="content">
<div class="container-fluid">

{% if sel_ordform %}

<div class="row">
  <div class="col-md-6">
    <div class="section-box">
      <h5><b>Order Info</b></h5>

      <div class="detail-row">
        <span class="detail-label">Order ID</span>
        <span class="detail-value">#{{ sel_ordform.first.id }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Order Date</span>
        <span class="detail-value">{{ sel_ordform.first.created_at|date:"d M Y" }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Payment ID</span>
        <span class="detail-value">{{ sel_ordform.first.payment_id|default:"—" }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Coupon Code</span>
        <span class="detail-value">{{ sel_ordform.first.couponcode|default:"NA" }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Influencer Code</span>
        <span class="detail-value">
          {{ sel_ordform.first.influencer_code|default:"NA" }}
        </span>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="section-box">
      <h5><b>Customer Details</b></h5>

      <div class="detail-row">
        <span class="detail-label">Name</span>
        <span class="detail-value">{{ sel_ordform.first.newname }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Phone</span>
        <span class="detail-value">{{ sel_ordform.first.phone }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Address</span>
        <span class="detail-value">
          {{ sel_ordform.first.address }},
          {{ sel_ordform.first.city }},
          {{ sel_ordform.first.state }},
          {{ sel_ordform.first.country }} - {{ sel_ordform.first.zip_code }}
        </span>
      </div>

      {% if sel_ordform.first.delivery_time %}
      <div class="detail-row">
        <span class="detail-label">Delivery Time</span>
        <span class="detail-value">{{ sel_ordform.first.delivery_time }}</span>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="section-box">
  <h5><b>Amount Summary</b></h5>

  <div class="detail-row">
    <span>Total Items</span>
    <span>{{ total_quantity }}</span>
  </div>

  <div class="detail-row">
    <span>Wallet Used</span>
    <span>₹{{ sel_ordform.first.walet_value }}</span>
  </div>

  <div class="detail-row">
    <span>Coupon Discount</span>
    <span>₹{{ sel_ordform.first.dicounted_price }}</span>
  </div>

  <div class="detail-row">
    <span>Taxable Amount</span>
    <span>₹{{ taxable_amount }}</span>
  </div>

  <div class="detail-row">
    <span>CGST</span>
    <span>₹{{ cgst }}</span>
  </div>

  <div class="detail-row">
    <span>SGST</span>
    <span>₹{{ sgst }}</span>
  </div>

  <div class="detail-row">
    <strong>Pay Amount</strong>
    <strong>₹{{ sel_ordform.first.total_price }}</strong>
  </div>
</div>

<div class="section-box">
  <h5><b>Order Status</b></h5>

  <form method="post" action="{% url 'newupdate_status' sel_ordform.first.id %}">
    {% csrf_token %}

    <div class="form-group">
      <select class="form-control" name="selected_status" id="status">
        <option value="1" {% if sel_ordform.first.status == "1" %}selected{% endif %}>Pending</option>
        <option value="2" {% if sel_ordform.first.status == "2" %}selected{% endif %}>Confirm</option>
        <option value="3" {% if sel_ordform.first.status == "3" %}selected{% endif %}>Picked Up</option>
        <option value="4" {% if sel_ordform.first.status == "4" %}selected{% endif %}>Delivered</option>
        <option value="5" {% if sel_ordform.first.status == "5" %}selected{% endif %}>Cancel</option>
      </select>
    </div>

    <div class="form-group" id="cancelReasonBox" style="display:none;">
      <label><b>Cancel Reason</b></label>
      <textarea name="cancel_reason" class="form-control" rows="3"
        placeholder="Enter cancellation reason">{{ sel_ordform.first.cancellation_reason }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary">Save Status</button>
  </form>
</div>

<div class="section-box">
  <h5><b>Order Timeline</b></h5>

  <ul class="timeline">
    <li>
      <strong>Order Placed</strong>
      <div class="text-muted">
        {{ sel_ordform.first.created_at|date:"d M Y, h:i A" }}
      </div>
    </li>

    {% if sel_ordform.first.confirmed_at %}
    <li>
      <strong>Order Confirmed</strong>
      <div class="text-muted">
        {{ sel_ordform.first.confirmed_at|date:"d M Y, h:i A" }}
      </div>
    </li>
    {% endif %}

    {% if sel_ordform.first.picked_up_at %}
    <li>
      <strong>Picked Up</strong>
      <div class="text-muted">
        {{ sel_ordform.first.picked_up_at|date:"d M Y, h:i A" }}
      </div>
    </li>
    {% endif %}

    {% if sel_ordform.first.delivered_at %}
    <li>
      <strong>Delivered</strong>
      <div class="text-muted">
        {{ sel_ordform.first.delivered_at|date:"d M Y, h:i A" }}
      </div>
    </li>
    {% endif %}

    {% if sel_ordform.first.cancelled_at %}
    <li>
      <strong>Cancelled</strong>
      <div class="text-danger">
        {{ sel_ordform.first.cancelled_at|date:"d M Y, h:i A" }}
      </div>
      {% if sel_ordform.first.cancellation_reason %}
        <div><b>Reason:</b> {{ sel_ordform.first.cancellation_reason }}</div>
      {% endif %}
    </li>
    {% endif %}
  </ul>
</div>

<div class="section-box">
<table id="example1" class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>#</th>
      <th>Item Name</th>
      <th>Qty</th>
      <th>Rate</th>
      <th>Purchase Price</th>
      <th>GST</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    {% for item in sel_ordform %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ item.product_id.title }}</td>
      <td>{{ item.quantity }} {{ item.product_id.item_measurement }}</td>
      <td>{{ item.product_id.item_old_price }}</td>
      <td>₹{{ item.product_id.item_new_price }}</td>
      <td>₹{{ item.gst_amount }}</td>
      <td>₹{{ item.price }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<div class="" style="padding: 15px; padding-top: 0;">
  <a href="{% url 'orderapp' %}" style="padding: 5px 25px;" class="btn btn-danger btn-lg">Back</a>
</div>

{% endif %}
</div>
</section>
</div>

<script>
  const statusSelect = document.getElementById("status");
  const reasonBox = document.getElementById("cancelReasonBox");

  function toggleReason() {
    reasonBox.style.display = statusSelect.value === "5" ? "block" : "none";
  }

  if (statusSelect) {
    statusSelect.addEventListener("change", toggleReason);
    toggleReason();
  }

  $(function () {
    $('#example1').DataTable({ paging: false });
  });
</script>

{% include 'backend/footer.html' %}
